generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id @default(cuid())
  discordId      String        @unique
  displayName    String
  avatarUrl      String?
  role           String        @default("user")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  status         String        @default("active")
  fantasyTeams   FantasyTeam[]
  proposedTrades Trade[]       @relation("TradeProposer")
  receivedTrades Trade[]       @relation("TradeReceiver")
  waiverClaims   WaiverClaim[]
  transactions     Transaction[]
}

model MLELeague {
  id          String    @id
  name        String
  colorHex    String
  colorHexTwo String?
  teams       MLETeam[]
}

model MLETeam {
  id             String            @id
  name           String
  leagueId       String
  slug           String            @unique
  logoPath       String
  primaryColor   String
  secondaryColor String
  players        MLEPlayer[]
  league         MLELeague         @relation(fields: [leagueId], references: [id])
  awayMatches    Match[]           @relation("AwayTeam")
  homeMatches    Match[]           @relation("HomeTeam")
  rosterSlots    RosterSlot[]
  weeklyStats    TeamWeeklyStats[]
}

model MLEPlayer {
  id                String                  @id
  name              String
  salary            Float?
  memberId          String?                 @unique
  skillGroup        String?                 // FL, AL, CL, ML, PL
  teamId            String?
  team              MLETeam?                @relation(fields: [teamId], references: [id])
  staffPosition     String?                 // Captain, Assistant General Manager, General Manager, Franchise Manager
  rosterSlot        String?                 // A, B, C, D, E, F, G, H, NONE
  roleUsages        RoleUsage[]
  matchStats        PlayerMatchStats[]
  historicalStats   PlayerHistoricalStats[]
}

model RoleUsage {
  id          String    @id @default(cuid())
  playerId    String
  role        String
  gamesPlayed Int
  player      MLEPlayer @relation(fields: [playerId], references: [id])

  @@unique([playerId, role])
}

model Fixture {
  id      String   @id
  date    DateTime
  matches Match[]
}

model Match {
  id            String             @id
  fixtureId     String
  roundId       String
  matchGroupId  String
  homeTeamId    String
  awayTeamId    String
  scheduledDate DateTime
  week          Int
  completed     Boolean            @default(false)
  awayTeam      MLETeam            @relation("AwayTeam", fields: [awayTeamId], references: [id])
  fixture       Fixture            @relation(fields: [fixtureId], references: [id])
  homeTeam      MLETeam            @relation("HomeTeam", fields: [homeTeamId], references: [id])
  playerStats   PlayerMatchStats[]
}

model PlayerMatchStats {
  id             String    @id @default(cuid())
  playerId       String
  matchId        String
  goals          Int
  shots          Int
  saves          Int
  assists        Int
  demosInflicted Int
  demosTaken     Int
  sprocketRating Float
  match          Match     @relation(fields: [matchId], references: [id])
  player         MLEPlayer @relation(fields: [playerId], references: [id])

  @@unique([playerId, matchId])
}

model PlayerHistoricalStats {
  id                  String    @id @default(cuid())
  playerId            String
  totalGoals          Int
  totalShots          Int
  totalSaves          Int
  totalAssists        Int
  gamesPlayed         Int
  assistsPerGame      Float
  avgDemosInflicted   Float
  avgDemosTaken       Float
  avgGoalsAgainst     Float
  avgScore            Float
  avgShotsAgainst     Float
  gamemode            String
  goalsPerGame        Float
  savesPerGame        Float
  season              String
  shotsPerGame        Float
  skillGroup          String
  sprocketRating      Float
  totalDemosInflicted Int
  totalDemosTaken     Int
  totalGoalsAgainst   Int
  totalShotsAgainst   Int
  player              MLEPlayer @relation(fields: [playerId], references: [id])

  @@unique([playerId, season, gamemode])
}

model TeamWeeklyStats {
  id             String  @id @default(cuid())
  teamId         String
  week           Int
  goals          Int
  shots          Int
  saves          Int
  assists        Int
  demosInflicted Int
  demosTaken     Int
  sprocketRating Float
  wins           Int
  losses         Int
  team           MLETeam @relation(fields: [teamId], references: [id])

  @@unique([teamId, week])
}

model FantasyLeague {
  id                   String        @id @default(cuid())
  name                 String
  season               Int
  maxTeams             Int           @default(12)
  currentWeek          Int           @default(1)
  playoffTeams         Int           @default(4)
  draftType            String
  waiverSystem         String
  faabBudget           Int?
  rosterConfig         Json
  createdAt            DateTime      @default(now())
  createdByUserId      String
  draftPickDeadline    DateTime?
  draftPickTimeSeconds Int?          @default(90)
  draftStatus          String?       @default("not_started")
  draftPicks           DraftPick[]
  fantasyTeams         FantasyTeam[]
  matchups             Matchup[]
  trades               Trade[]
  waivers              WaiverClaim[]
  transactions    Transaction[]
}

model FantasyTeam {
  id              String        @id @default(cuid())
  fantasyLeagueId String
  ownerUserId     String
  displayName     String
  shortCode       String
  draftPosition   Int?
  faabRemaining   Int?
  waiverPriority  Int?
  league          FantasyLeague @relation(fields: [fantasyLeagueId], references: [id])
  owner           User          @relation(fields: [ownerUserId], references: [id])
  awayMatchups    Matchup[]     @relation("AwayFantasyTeam")
  homeMatchups    Matchup[]     @relation("HomeFantasyTeam")
  roster          RosterSlot[]
  proposedTrades  Trade[]       @relation("TradeProposerTeam")
  receivedTrades  Trade[]       @relation("TradeReceiverTeam")
  waiverClaims    WaiverClaim[]
  transactions      Transaction[]

  @@unique([fantasyLeagueId, ownerUserId])
}

model RosterSlot {
  id            String      @id @default(cuid())
  fantasyTeamId String
  mleTeamId     String
  week          Int
  position      String
  slotIndex     Int
  isLocked      Boolean     @default(false)
  fantasyPoints Float?
  fantasyTeam   FantasyTeam @relation(fields: [fantasyTeamId], references: [id])
  mleTeam       MLETeam     @relation(fields: [mleTeamId], references: [id])

  @@unique([fantasyTeamId, week, position, slotIndex])
  @@index([week])
}

model DraftPick {
  id              String        @id @default(cuid())
  fantasyLeagueId String
  round           Int
  pickNumber      Int
  overallPick     Int
  fantasyTeamId   String?
  mleTeamId       String?
  pickedAt        DateTime?
  league          FantasyLeague @relation(fields: [fantasyLeagueId], references: [id])

  @@unique([fantasyLeagueId, overallPick])
  @@index([fantasyLeagueId, round, pickNumber])
}

model Trade {
  id              String        @id @default(cuid())
  fantasyLeagueId String
  proposerTeamId  String
  receiverTeamId  String
  proposerUserId  String
  receiverUserId  String
  proposerGives   String[]
  receiverGives   String[]
  status          String        @default("pending")
  executedAt      DateTime?
  createdAt       DateTime      @default(now())
  league          FantasyLeague @relation(fields: [fantasyLeagueId], references: [id])
  proposerTeam    FantasyTeam   @relation("TradeProposerTeam", fields: [proposerTeamId], references: [id])
  proposer        User          @relation("TradeProposer", fields: [proposerUserId], references: [id])
  receiverTeam    FantasyTeam   @relation("TradeReceiverTeam", fields: [receiverTeamId], references: [id])
  receiver        User          @relation("TradeReceiver", fields: [receiverUserId], references: [id])
}

model WaiverClaim {
  id              String        @id @default(cuid())
  fantasyLeagueId String
  fantasyTeamId   String
  userId          String
  addTeamId       String
  dropTeamId      String?
  faabBid         Int?
  priority        Int
  status          String        @default("pending")
  processedAt     DateTime?
  createdAt       DateTime      @default(now())
  league          FantasyLeague @relation(fields: [fantasyLeagueId], references: [id])
  fantasyTeam     FantasyTeam   @relation(fields: [fantasyTeamId], references: [id])
  user            User          @relation(fields: [userId], references: [id])
}

// ============================================================================
// TRANSACTION HISTORY
// ============================================================================

model Transaction {
  id              String        @id @default(cuid())
  fantasyLeagueId String
  fantasyTeamId   String
  userId          String

  type            String        // "waiver", "trade", "pickup", "drop"

  // MLE Teams involved
  addTeamId       String?       // MLE team added to roster
  dropTeamId      String?       // MLE team dropped from roster

  // Trade-specific fields
  tradeId         String?       // Reference to Trade if applicable
  tradePartnerTeamId String?    // Other fantasy team in trade
  tradePartnerGave String[]     @default([]) // MLE teams received from trade partner

  // Waiver-specific fields
  waiverClaimId   String?       // Reference to WaiverClaim if applicable
  faabBid         Int?          // FAAB amount spent

  // Status and metadata
  status          String        // "approved", "denied", "failed", "vetoed"
  reason          String?       // Reason for denial/failure
  processedAt     DateTime      @default(now())

  league          FantasyLeague @relation(fields: [fantasyLeagueId], references: [id])
  fantasyTeam     FantasyTeam   @relation(fields: [fantasyTeamId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([fantasyLeagueId])
  @@index([fantasyTeamId])
  @@index([processedAt])
}

model Matchup {
  id              String        @id @default(cuid())
  fantasyLeagueId String
  week            Int
  homeTeamId      String
  awayTeamId      String
  homeScore       Float?
  awayScore       Float?
  isPlayoff       Boolean       @default(false)
  awayTeam        FantasyTeam   @relation("AwayFantasyTeam", fields: [awayTeamId], references: [id])
  league          FantasyLeague @relation(fields: [fantasyLeagueId], references: [id])
  homeTeam        FantasyTeam   @relation("HomeFantasyTeam", fields: [homeTeamId], references: [id])

  @@unique([fantasyLeagueId, week, homeTeamId])
  @@index([week])
}

model SeasonSettings {
  id               String   @id @default(cuid())
  season           Int      @unique
  currentWeek      Int
  playoffStartWeek Int      @default(9)
  tradeCutoffWeek  Int      @default(8)
  lineupLockTime   String   @default("00:01")
  weekDates        Json
  scoringRules     Json
  waiverSchedule   Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model ManualStatsOverride {
  id             String   @id @default(cuid())
  teamId         String
  week           Int
  goals          Int
  shots          Int
  saves          Int
  assists        Int
  adminUserId    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  demosInflicted Int
  demosTaken     Int
  gameRecord     String
  saveRate       Float

  @@unique([teamId, week])
  @@index([week])
  @@index([teamId])
}
